<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全台停班停課即時資訊</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 原有的樣式保留 */
        .card {
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        
        /* 新增載入動畫樣式 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 表格樣式調整 */
        .table td {
            white-space: nowrap;  /* 縣市強制橫式 */
        }
        
        .table td:last-child {
            white-space: normal;  /* 內容可以換行 */
            min-width: 200px;     /* 設定最小寬度 */
        }

        /* RWD 調整 */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .table {
                font-size: 0.9rem;
            }
            
            .col-md-4 {
                margin-bottom: 20px;
            }
            
            h3 {
                font-size: 1.5rem;
            }
            
            .table td:last-child {
                min-width: 150px;  /* 手機版縮小最小寬度 */
            }

            /* 確保在手機版時表格可以水平捲動 */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 576px) {
            .table {
                font-size: 0.8rem;
            }
            
            h3 {
                font-size: 1.2rem;
            }
            
            .table td:last-child {
                min-width: 120px;  /* 更小螢幕進一步縮小寬度 */
            }

            /* 調整容器邊距 */
            .container {
                padding: 0 5px;
            }

            /* 調整標題大小 */
            h1 {
                font-size: 1.5rem;
            }
        }

        /* 表格內容美化 */
        .table-warning {
            background-color: #fff3cd !important;
        }
        
        .table td, .table th {
            vertical-align: middle;
        }
        
        /* 區域標題樣式 */
        h3 {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        /* 容器間距調整 */
        .row > div {
            margin-bottom: 2rem;
        }

        /* 新增暗色模式相關樣式 */
        :root {
            --dark-bg: #1a1a1a;
            --dark-text: #ffffff;
            --dark-table-border: #4c4c4c;
            --dark-hover: rgba(64, 158, 255, 0.2);
        }

        /* 暗色主題類 */
        .dark-theme {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .dark-theme .table {
            color: var(--dark-text);
            background-color: var(--dark-bg);
        }

        .dark-theme .table td, 
        .dark-theme .table th {
            border-color: var(--dark-table-border);
        }

        .dark-theme .text-muted {
            color: #a0a0a0 !important;
        }

        .dark-theme .table-warning,
        .dark-theme td[style*="background-color: rgb(255, 243, 205)"] {
            background-color: #2c2c1f !important;
            color: #ffd700 !important;
        }

        .dark-theme h3 {
            background-color: #2c2c2c;
        }

        /* 主題切換按鈕樣式 */
        .theme-switch-wrapper {
            display: flex;
            justify-content: flex-end;
            padding: 0 1rem;
            margin-bottom: 1rem;
        }

        .theme-switch-btn {
            background: none;
            border: 2px solid #666;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark-theme .theme-switch-btn {
            border-color: #888;
            color: var(--dark-text);
        }

        .light-icon, .dark-icon {
            font-size: 1.2rem;
        }

        .dark-theme .light-icon,
        .light-theme .dark-icon {
            display: none;
        }

        /* 全域字體設定 */
        body {
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
        }

        /* 確保標題也使用相同字體 */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
        }

        /* 表格內容字體 */
        .table {
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
        }

        /* 字重調整 */
        h1 {
            font-weight: 700;  /* 粗體 */
        }
        
        h3 {
            font-weight: 500;  /* 中等粗細 */
        }
        
        .table th {
            font-weight: 500;  /* 表格標題中等粗細 */
        }
        
        .table td {
            font-weight: 400;  /* 表格內容正常粗細 */
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="theme-switch-wrapper">
            <button class="theme-switch-btn" id="themeToggle">
                <span class="light-icon">☀️</span>
                <span class="dark-icon">🌙</span>
            </button>
        </div>
        <h1 class="text-center mb-4">全台停班停課即時資訊</h1>
        
        <!-- 載入動畫 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <!-- 資料顯示區域 -->
        <div id="data-container" style="display: none;">
            <div class="row">
                <!-- 北部地區 -->
                <div class="col-12 col-md-4">
                    <h3 class="text-center">北部地區🐲</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center">縣市</th>
                                    <th class="text-center">停班停課狀態</th>
                                </tr>
                            </thead>
                            <tbody id="northTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 中部地區 -->
                <div class="col-12 col-md-4">
                    <h3 class="text-center">中部地區🪨</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center">縣市</th>
                                    <th class="text-center">停班停課狀態</th>
                                </tr>
                            </thead>
                            <tbody id="centralTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 南部地區 -->
                <div class="col-12 col-md-4">
                    <h3 class="text-center">南部地區🐖</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center">縣市</th>
                                    <th class="text-center">停班停課狀態</th>
                                </tr>
                            </thead>
                            <tbody id="southTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 東部地區 -->
                <div class="col-12 col-md-4">
                    <h3 class="text-center">東部地區🌼</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center">縣市</th>
                                    <th class="text-center">停班停課狀態</th>
                                </tr>
                            </thead>
                            <tbody id="eastTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 外島地區 -->
                <div class="col-12 col-md-4">
                    <h3 class="text-center">外島地區🏝️</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center">縣市</th>
                                    <th class="text-center">停班停課狀態</th>
                                </tr>
                            </thead>
                            <tbody id="islandTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CORS_PROXY = "https://corsproxy.io/?";
        const RSS_URL = "https://alerts.ncdr.nat.gov.tw/RssAtomFeed.ashx?AlertType=33";
        
        // 定義縣市分類
        const regions = {
            north: ['臺北市', '新北市', '基隆市', '桃園市', '新竹市', '新竹縣'],
            central: ['苗栗縣', '臺中市', '彰化縣', '南投縣', '雲林縣'],
            south: ['嘉義市', '嘉義縣', '臺南市', '高雄市', '屏東縣'],
            east: ['宜蘭縣', '花蓮縣', '臺東縣'],
            island: ['澎湖縣', '金門縣', '連江縣']
        };

        function processData(data) {
            const entries = data.getElementsByTagName("entry");
            const alerts = {};
            
            Array.from(entries).forEach(entry => {
                const summary = entry.getElementsByTagName("summary")[0].textContent;
                const updated = entry.getElementsByTagName("updated")[0].textContent;
                
                // 解析縣市和狀態
                const match = summary.match(/\[(停班停課通知)\](.*?):/);
                if (match) {
                    const city = match[2].trim();
                    alerts[city] = {
                        status: summary,
                        time: updated
                    };
                }
            });

            return alerts;
        }

        function updateTables(alerts) {
            Object.keys(regions).forEach(region => {
                const tableBody = document.getElementById(`${region}Table`);
                if (tableBody) {
                    tableBody.innerHTML = regions[region].map(city => {
                        const alert = alerts[city];
                        return `
                            <tr>
                                <td class="text-center">${city}</td>
                                <td class="text-center ${alert ? 'table-warning' : ''}">${alert ? alert.status : '正常上班上課'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            });
        }

        // 添加延遲函數
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 添加重試機制的fetch函數
        async function fetchWithRetry(url, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.text();
                } catch (error) {
                    console.log(`嘗試第 ${i + 1} 次失敗:`, error);
                    if (i === retries - 1) throw error;
                    await delay(1000); // 等待1秒後重試
                }
            }
        }

        // 更新載入資料的部分
        fetchWithRetry(CORS_PROXY + encodeURIComponent(RSS_URL))
            .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
            .then(data => {
                const alerts = processData(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-container').style.display = 'block';
                updateTables(alerts);
            })
            .catch(error => {
                console.error('Error fetching RSS feed:', error);
                document.getElementById('loading').innerHTML = "無法載入資料，請稍後再試";
            });

        // 添加主題切換功能
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            
            // 檢查本地存儲的主題設置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.className = savedTheme;
            } else {
                // 如果沒有保存的主題，則使用系統預設
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.className = 'dark-theme';
                } else {
                    document.body.className = 'light-theme';
                }
            }
            
            // 切換主題
            themeToggle.addEventListener('click', () => {
                if (document.body.className === 'light-theme') {
                    document.body.className = 'dark-theme';
                    localStorage.setItem('theme', 'dark-theme');
                } else {
                    document.body.className = 'light-theme';
                    localStorage.setItem('theme', 'light-theme');
                }
            });
            
            // 監聽系統主題變化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    document.body.className = e.matches ? 'dark-theme' : 'light-theme';
                }
            });
        });
    </script>
</body>
</html> 